name: MainWorkflow

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - workflow

# concurrency:
#   group: deploy-group
#   cancel-in-progress: true

permissions:
  id-token: write
  contents: read
  # security-events: write
  # actions: read

jobs:
  # root pipelines
  buildRoot:
    name: Build Root
    runs-on: ubuntu-latest
    steps:
      - name: Print job name
        run:
          echo "Job name is ${{ github.job }}"

          # - name: Setup pnpm environment
          #   uses: ./.github/actions/setup-pnpm

      # - name: Upload build output
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: build-output
      #     path: ./dist

  deployRootDev:
    name: Deploy Dev Env
    needs: buildRoot
    runs-on: ubuntu-latest
    environment: Dev
    steps:
      - name: Print job name
        run: echo "Job name is ${{ github.job }}"

      # - name: Checkout code
      #   uses: actions/checkout@v4

      # - name: setup environment
      #   uses: ./.github/actions/setup-azure
      #   with:
      #     clientId: ${{ secrets.AZURE_CLIENT_ID }}
      #     tenantId: ${{ secrets.AZURE_TENANT_ID }}
      #     subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # - name: Create env file & echo target name
      #   working-directory: deploy
      #   run: |
      #     echo "TARGET_ENV_NAME:${{ vars.TARGET_ENV_NAME }}"
      #     echo "TARGET_ENV=${{ vars.TARGET_ENV_NAME }}" >> .env

      # - name: Read env file
      #   run: cat deploy/.env

      # - name: Set deployment environment
      #   run: |
      #     echo "TF_VAR_env_type=dev" >> $GITHUB_ENV
      #     echo "TF_VAR_deployer_sp_object_id=${{ secrets.AZURE_DEPLOYER_SP_OBJECT_ID }}" >> $GITHUB_ENV
      #     echo "TF_VAR_deployer_sp_name=github-oidc" >> $GITHUB_ENV

      # - name: Run Terraform for deployEnv
      #   working-directory: deploy/deployEnv
      #   run: node ./deployEnvironment.js  --auto-approve

  testRootDev:
    name: Test Dev Env
    needs: deployRootDev
    runs-on: ubuntu-latest
    steps:
      - name: Print job name
        run: echo "Job name is ${{ github.job }}"

  deployRootTest:
    name: Deploy Test Env
    needs: testRootDev
    runs-on: ubuntu-latest
    # environment: Test
    steps:
      - name: Print job name
        run: echo "Job name is ${{ github.job }}"
      - name: Simulate failure
        run: |
          echo "Simulating failure"
          exit 1

  testRootTest:
    name: Test Test Env
    needs: deployRootTest
    runs-on: ubuntu-latest
    steps:
      - name: Print job name
        run: echo "Job name is ${{ github.job }}"

  deployRootProd:
    name: Deploy Prod Env
    needs: testRootTest
    runs-on: ubuntu-latest
    environment: Prod
    steps:
      - name: Print job name
        run: echo "Job name is ${{ github.job }}"

  testRootProd:
    name: Test Prod Env
    needs: deployRootProd
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  # modules pipelines
  buildProfile:
    name: Build Profile
    needs:
      - buildRoot
      - deployRootDev
    # if: always()
    runs-on: ubuntu-latest
    environment: Dev
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"
      # - name: Checkout code
      #   uses: actions/checkout@v4

      # - name: setup environment
      #   uses: ./.github/actions/setup-azure
      #   with:
      #     clientId: ${{ secrets.AZURE_CLIENT_ID }}
      #     tenantId: ${{ secrets.AZURE_TENANT_ID }}
      #     subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # - name: Create env file & echo target name
      #   working-directory: deploy
      #   run: |
      #     echo "TARGET_ENV_NAME:${{ vars.TARGET_ENV_NAME }}"
      #     echo "TARGET_ENV=${{ vars.TARGET_ENV_NAME }}" >> .env

      # - name: Read env file
      #   run: cat deploy/.env

      # - name: Set deployment environment
      #   run: |
      #     echo "TF_VAR_env_type=dev" >> $GITHUB_ENV
      #     echo "TF_VAR_deployer_sp_name=github-oidc" >> $GITHUB_ENV

      # - name: Run Terraform for Function App env and database security
      #   working-directory: module/profile/func/deploy/env
      #   run: |
      #     node ./deployEnvironment.js --auto-approve
      #     node ./databaseSecurity.js
      # - name: Update database schema and initialize data
      #   working-directory: module/profile/func/deploy/db
      #   run: |
      #     node ./updateDbSchema.js
      #     node ./initData.js

      # - name: Deploy Function App code
      #   working-directory: module/profile/func/deploy/code
      #   run: node ./deploy.js

      # # - name: Verify Function App deployment
      # #   working-directory: module/profile/func/deploy/verify
      # #   run: node ./verifyDeployment.js

  deployProfileDev:
    name: Deploy Profile Dev
    needs:
      - buildProfile
      - deployRootDev
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  testProfileDev:
    name: Test Profile Dev
    needs: deployProfileDev
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  deployProfileTest:
    name: Deploy Profile Test
    needs:
      - testProfileDev
      - deployRootTest
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  testProfileTest:
    name: Test Profile Test
    needs: deployProfileTest
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  deployProfileProd:
    name: Deploy Profile Prod
    needs:
      - testProfileTest
      - deployRootProd
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  testProfileProd:
    name: Test Profile Prod
    needs: deployProfileProd
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"
  buildQuest3Tier:
    name: Build Quest3Tier
    needs:
      - buildRoot
      - deployRootDev
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

      - name: Simulate failure
        run: |
          echo "Simulating failure"
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4

      - name: build quest3Tier
        uses: ./.github/actions/module-build
        with:
          moduleName: quest3Tier

  deployQuest3TierDev:
    name: Deploy Quest3Tier Dev
    needs:
      - buildQuest3Tier
      - deployRootDev
    # if: always()
    runs-on: ubuntu-latest
    environment: Dev
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: setup environment
        uses: ./.github/actions/setup-azure
        with:
          clientId: ${{ secrets.AZURE_CLIENT_ID }}
          tenantId: ${{ secrets.AZURE_TENANT_ID }}
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: deploy quest3Tier
        uses: ./.github/actions/module-deploy
        with:
          moduleName: quest3Tier
          targetEnvName: ${{ vars.TARGET_ENV_NAME }}
          envType: dev
          deployerName: github-oidc

  testQuest3TierDev:
    name: Test Quest3Tier Dev
    needs: deployQuest3TierDev
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  deployQuest3TierTest:
    name: Deploy Quest3Tier Test
    needs:
      - testQuest3TierDev
      - deployRootTest
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  testQuest3TierTest:
    name: Test Quest3Tier Test
    needs: deployQuest3TierTest
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  deployQuest3TierProd:
    name: Deploy Quest3Tier Prod
    needs:
      - testQuest3TierTest
      - deployRootProd
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  testQuest3TierProd:
    name: Test Quest3Tier Prod
    needs: deployQuest3TierProd
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  # Ui pipelines
  buildUi:
    name: Build Ui
    needs:
      - buildRoot
      - deployRootDev
    # if: always()
    runs-on: ubuntu-latest
    environment: Dev
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm environment
        uses: ./.github/actions/setup-pnpm

      - name: Build ui code with pnpm
        working-directory: ui
        shell: bash
        run: |
          pnpm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: my-artifacts-ui
          path: |
            ui/dist/client

  deployUiDev:
    name: Deploy Ui Dev
    needs:
      - buildUi
      - deployRootDev
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: setup environment
        uses: ./.github/actions/setup-azure
        with:
          clientId: ${{ secrets.AZURE_CLIENT_ID }}
          tenantId: ${{ secrets.AZURE_TENANT_ID }}
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create env file & echo target name
        working-directory: deploy
        run: |
          echo "TARGET_ENV_NAME:${{ vars.TARGET_ENV_NAME }}"
          echo "TARGET_ENV=${{ vars.TARGET_ENV_NAME }}" >> .env

      - name: Read env file
        run: cat deploy/.env

      - name: Set deployment environment
        run: |
          echo "TF_VAR_env_type=dev" >> $GITHUB_ENV
          echo "TF_VAR_deployer_sp_object_id=${{ secrets.AZURE_DEPLOYER_SP_OBJECT_ID }}" >> $GITHUB_ENV
          echo "TF_VAR_deployer_sp_name=github-oidc" >> $GITHUB_ENV

      - name: Run Terraform for Function App env and database security
        working-directory: ui/deploy/env
        run: |
          node ./deployEnvironment.js --auto-approve

      - uses: actions/download-artifact@v4
        with:
          name: my-artifacts-ui
          path: ui/deploy/code/downloaded-artifacts

      - name: Deploy Application code
        working-directory: ui/deploy/code
        run: node ./deploy.js  --deployFile ./downloaded-artifacts

      - name: Verify the deployment
        working-directory: ui/deploy/verify
        run: node ./verifyDeployment.js

  testUiDev:
    name: Test Ui Dev
    needs: deployUiDev
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  deployUiTest:
    name: Deploy Ui Test
    needs:
      - testUiDev
      - deployRootTest
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  testUiTest:
    name: Test Ui Test
    needs: deployUiTest
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  deployUiProd:
    name: Deploy Ui Prod
    needs:
      - testUiTest
      - deployRootProd
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  testUiProd:
    name: Test Ui Prod
    needs: deployUiProd
    # if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  activateDev:
    name: Activate Dev Env
    needs:
      - testRootDev
      - testProfileDev
    runs-on: ubuntu-latest
    environment: Dev
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  activateTest:
    name: Activate Test Env
    needs:
      - testRootTest
      - testProfileTest
    runs-on: ubuntu-latest
    environment: Test
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"

  activateProd:
    name: Activate Prod Env
    needs:
      - testRootProd
      - testProfileProd
    runs-on: ubuntu-latest
    environment: Prod
    steps:
      - name: Echo job name
        run: echo "Job name is ${{ github.job }}"
